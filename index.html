<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Секундомер для соревнований</title>
    <style>
        :root {
            --primary-color: #4f46e5;
            --secondary-color: #7c3aed;
            --background-color: #1a1a1a;
            --card-color: #2d2d2d;
            --text-color: #ffffff;
            --text-secondary: #b3b3b3;
            --accent-color: #10b981;
            --danger-color: #ef4444;
            --success-color: #10b981;
            --warning-color: #f59e0b;
        }

        [data-theme="light"] {
            --primary-color: #4f46e5;
            --secondary-color: #7c3aed;
            --background-color: #f5f5f5;
            --card-color: #ffffff;
            --text-color: #1a1a1a;
            --text-secondary: #6b7280;
            --accent-color: #10b981;
            --danger-color: #ef4444;
            --success-color: #10b981;
            --warning-color: #f59e0b;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: var(--background-color);
            color: var(--text-color);
            min-height: 100vh;
            padding: 0;
            transition: background-color 0.3s ease;
        }

        .container {
            max-width: 100%;
            padding: 16px;
            margin: 0 auto;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 0;
            position: sticky;
            top: 0;
            z-index: 100;
            background: var(--background-color);
        }

        .logo {
            width: 140px;
            height: auto;
        }

        .menu-btn {
            background: none;
            border: none;
            color: var(--text-color);
            font-size: 24px;
            cursor: pointer;
            padding: 8px;
            border-radius: 8px;
            transition: background-color 0.2s;
        }

        .menu-btn:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .dropdown-menu {
            position: absolute;
            right: 16px;
            top: 60px;
            background: var(--card-color);
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            padding: 12px 0;
            min-width: 200px;
            z-index: 1000;
            display: none;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .dropdown-menu.show {
            display: block;
        }

        .dropdown-item {
            padding: 12px 16px;
            cursor: pointer;
            transition: background-color 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .dropdown-item:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .theme-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .main-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 32px 0;
            gap: 24px;
        }

        .competition-btn {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            border: none;
            border-radius: 16px;
            padding: 16px 32px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 12px;
            box-shadow: 0 4px 16px rgba(79, 70, 229, 0.3);
            transition: all 0.3s ease;
            min-width: 280px;
        }

        .competition-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(79, 70, 229, 0.4);
        }

        .competition-btn:active {
            transform: translateY(0);
        }

        .btn-icon {
            font-size: 24px;
            font-weight: bold;
        }

        .confirmation-dialog, .delete-confirmation-dialog, .clear-history-dialog {
            background: var(--card-color);
            padding: 24px;
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            text-align: center;
            max-width: 320px;
            margin: 24px auto;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1000;
            display: none;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .confirmation-dialog.show, .delete-confirmation-dialog.show, .clear-history-dialog.show {
            display: block;
        }

        .confirmation-title {
            font-size: 18px;
            margin-bottom: 16px;
            font-weight: 600;
        }

        .confirmation-options {
            display: flex;
            gap: 16px;
            justify-content: center;
        }

        .confirm-btn, .cancel-btn, .delete-btn, .clear-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .confirm-btn, .delete-btn, .clear-btn {
            background: var(--danger-color);
            color: white;
        }

        .cancel-btn {
            background: var(--text-secondary);
            color: var(--text-color);
        }

        .confirm-btn:hover, .cancel-btn:hover, .delete-btn:hover, .clear-btn:hover {
            opacity: 0.9;
            transform: scale(1.05);
        }

        .participants-section {
            width: 100%;
            max-width: 600px;
        }

        .add-participant-btn {
            background: linear-gradient(135deg, var(--accent-color), #059669);
            color: white;
            border: none;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 16px rgba(16, 185, 129, 0.3);
            margin: 16px auto;
            transition: all 0.3s ease;
        }

        .add-participant-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(16, 185, 129, 0.4);
        }

        .participant-card {
            background: var(--card-color);
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 16px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            position: relative;
            border: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            flex-direction: column;
        }

        .participant-header {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 12px;
        }

        .participant-number {
            background: var(--primary-color);
            color: white;
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            font-weight: bold;
        }

        .participant-comment {
            flex: 1;
            font-size: 16px;
            padding: 8px 12px;
            border: none;
            background: transparent;
            color: var(--text-color);
            border-bottom: 2px solid transparent;
            transition: border-color 0.2s;
        }

        .participant-comment:focus {
            outline: none;
            border-bottom: 2px solid var(--primary-color);
        }

        .action-buttons {
            display: flex;
            gap: 8px;
            margin-top: 8px;
        }

        .start-btn, .stop-btn {
            background: var(--accent-color);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 8px 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            flex: 1;
        }

        .stop-btn {
            background: var(--danger-color);
        }

        .start-btn:hover, .stop-btn:hover {
            opacity: 0.9;
            transform: scale(1.05);
        }

        .start-btn.disabled {
            background: #6b7280;
            cursor: not-allowed;
            opacity: 0.6;
        }

        .start-btn.disabled:hover {
            transform: none;
            opacity: 0.6;
        }

        .delete-text {
            color: var(--warning-color);
            font-weight: 600;
            cursor: pointer;
            padding: 10px 0;
            margin-top: 20px;
            text-align: center;
            transition: all 0.2s;
            border-radius: 4px;
            font-size: 14px;
        }

        .delete-text:hover {
            background: rgba(245, 158, 11, 0.1);
            transform: scale(1.03);
        }

        .participant-timer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 12px;
            padding: 12px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            font-size: 14px;
        }

        .timer-value {
            font-size: 18px;
            font-weight: 600;
            color: var(--accent-color);
        }

        .group-container {
            margin-bottom: 16px;
        }

        .group-toggle {
            background: var(--card-color);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 12px 16px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.2s;
        }

        .group-toggle:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .group-content {
            margin-top: 8px;
            display: none;
        }

        .group-content.show {
            display: block;
        }

        .competition-time {
            font-size: 24px;
            font-weight: bold;
            margin: 16px 0;
            color: var(--accent-color);
        }

        .hidden {
            display: none;
        }

        .file-input {
            display: none;
        }

        .success-message, .error-message {
            padding: 12px 24px;
            border-radius: 8px;
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            display: none;
            animation: slideIn 0.3s ease-out;
        }

        .success-message {
            background: var(--success-color);
            color: white;
        }

        .error-message {
            background: var(--danger-color);
            color: white;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-50%) translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }
        }

        @media (max-width: 480px) {
            .participant-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }
            
            .participant-number {
                width: 40px;
                height: 40px;
                font-size: 18px;
            }
            
            .competition-btn {
                min-width: 240px;
                padding: 14px 24px;
                font-size: 16px;
            }
            
            .action-buttons {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <img src="logo.png" alt="Логотип" class="logo">
            <button class="menu-btn" id="menuBtn">☰</button>
            <div class="dropdown-menu" id="dropdownMenu">
                <div class="dropdown-item theme-toggle" id="themeToggle">
                    <span>Темная тема</span>
                    <div id="themeSwitch" style="width: 40px; height: 20px; background: #ccc; border-radius: 10px; position: relative;">
                        <div id="themeSwitchHandle" style="width: 18px; height: 18px; background: white; border-radius: 50%; position: absolute; top: 1px; right: 1px;"></div>
                    </div>
                </div>
                <div class="dropdown-item" id="exportBtn">
                    📤 Экспорт таблицы
                </div>
                <div class="dropdown-item" id="importBtn">
                    📥 Импорт таблицы
                    <input type="file" id="fileInput" class="file-input" accept=".csv">
                </div>
                <div class="dropdown-item" id="clearHistoryBtn">
                    🗑️ Очистить историю
                </div>
            </div>
        </header>

        <main class="main-content">
            <button class="competition-btn" id="competitionBtn">
                <span class="btn-icon">▶</span>
                <span>Начать соревнование</span>
            </button>

            <div class="competition-time hidden" id="competitionTime">00:00:00.00</div>

            <section class="participants-section">
                <button class="add-participant-btn" id="addParticipantBtn">+</button>
                <div id="participantsContainer"></div>
                <div id="groupsContainer"></div>
            </section>
        </main>
    </div>

    <!-- Confirmation dialog for ending competition -->
    <div class="confirmation-dialog" id="confirmationDialog">
        <div class="confirmation-title">Действительно завершить соревнование?</div>
        <div class="confirmation-options">
            <button class="confirm-btn" id="confirmBtn">Да</button>
            <button class="cancel-btn" id="cancelBtn">Нет</button>
        </div>
    </div>

    <!-- Confirmation dialog for deleting participant -->
    <div class="delete-confirmation-dialog" id="deleteConfirmationDialog">
        <div class="confirmation-title">Удалить участника?</div>
        <div class="confirmation-options">
            <button class="delete-btn" id="deleteConfirmBtn">Да, удалить</button>
            <button class="cancel-btn" id="deleteCancelBtn">Отмена</button>
        </div>
    </div>

    <!-- Confirmation dialog for clearing history -->
    <div class="clear-history-dialog" id="clearHistoryDialog">
        <div class="confirmation-title">Очистить всю историю соревнования?</div>
        <p style="margin-bottom: 16px; font-size: 14px;">Это действие нельзя отменить. Все данные будут удалены.</p>
        <div class="confirmation-options">
            <button class="clear-btn" id="clearConfirmBtn">Да, очистить</button>
            <button class="cancel-btn" id="clearCancelBtn">Отмена</button>
        </div>
    </div>

    <div class="success-message" id="successMessage"></div>
    <div class="error-message" id="errorMessage"></div>

    <script>
        // Global variables
        let participants = [];
        let nextParticipantId = 1;
        let isCompetitionRunning = false;
        let competitionStartTime = null;
        let competitionTimerInterval = null;
        let competitionElapsedTime = 0;
        let competitionPausedTime = 0;
        let participantToDelete = null;

        // DOM Elements
        const competitionBtn = document.getElementById('competitionBtn');
        const confirmationDialog = document.getElementById('confirmationDialog');
        const confirmBtn = document.getElementById('confirmBtn');
        const cancelBtn = document.getElementById('cancelBtn');
        const competitionTimeDisplay = document.getElementById('competitionTime');
        const addParticipantBtn = document.getElementById('addParticipantBtn');
        const participantsContainer = document.getElementById('participantsContainer');
        const groupsContainer = document.getElementById('groupsContainer');
        const deleteConfirmationDialog = document.getElementById('deleteConfirmationDialog');
        const deleteConfirmBtn = document.getElementById('deleteConfirmBtn');
        const deleteCancelBtn = document.getElementById('deleteCancelBtn');
        const clearHistoryBtn = document.getElementById('clearHistoryBtn');
        const clearHistoryDialog = document.getElementById('clearHistoryDialog');
        const clearConfirmBtn = document.getElementById('clearConfirmBtn');
        const clearCancelBtn = document.getElementById('clearCancelBtn');
        const exportBtn = document.getElementById('exportBtn');
        const importBtn = document.getElementById('importBtn');
        const fileInput = document.getElementById('fileInput');
        const successMessage = document.getElementById('successMessage');
        const errorMessage = document.getElementById('errorMessage');
        const menuBtn = document.getElementById('menuBtn');
        const dropdownMenu = document.getElementById('dropdownMenu');
        const themeToggle = document.getElementById('themeToggle');
        const themeSwitch = document.getElementById('themeSwitch');
        const themeSwitchHandle = document.getElementById('themeSwitchHandle');

        // Load data from localStorage on page load
        function loadData() {
            try {
                const savedData = localStorage.getItem('stopwatchData');
                if (savedData) {
                    const data = JSON.parse(savedData);
                    participants = data.participants || [];
                    nextParticipantId = data.nextParticipantId || 1;
                    isCompetitionRunning = data.isCompetitionRunning || false;
                    competitionStartTime = data.competitionStartTime || null;
                    competitionElapsedTime = data.competitionElapsedTime || 0;
                    
                    if (isCompetitionRunning && competitionStartTime) {
                        startCompetitionTimer();
                        competitionTimeDisplay.classList.remove('hidden');
                        competitionBtn.innerHTML = '<span class="btn-icon">■</span><span>Завершить соревнование</span>';
                    }
                } else {
                    // Initialize with default data
                    participants = [];
                    nextParticipantId = 1;
                    isCompetitionRunning = false;
                    competitionStartTime = null;
                    competitionElapsedTime = 0;
                }
                
                renderParticipants();
            } catch (e) {
                console.error('Error loading data:', e);
                // Initialize with default data if there's an error
                participants = [];
                nextParticipantId = 1;
                isCompetitionRunning = false;
                competitionStartTime = null;
                competitionElapsedTime = 0;
                renderParticipants();
            }
            
            // Load theme
            const savedTheme = localStorage.getItem('theme') || 'dark';
            if (savedTheme === 'light') {
                document.body.setAttribute('data-theme', 'light');
                themeSwitchHandle.style.right = '1px';
                themeSwitchHandle.style.left = 'auto';
                document.querySelector('.theme-toggle span').textContent = 'Светлая тема';
            } else {
                themeSwitchHandle.style.left = '1px';
                themeSwitchHandle.style.right = 'auto';
                document.querySelector('.theme-toggle span').textContent = 'Темная тема';
            }
        }

        // Save data to localStorage
        function saveData() {
            try {
                const data = {
                    participants: participants.map(p => ({
                        ...p,
                        timerInterval: null // Don't save interval references
                    })),
                    nextParticipantId,
                    isCompetitionRunning,
                    competitionStartTime,
                    competitionElapsedTime
                };
                localStorage.setItem('stopwatchData', JSON.stringify(data));
            } catch (e) {
                console.error('Error saving data:', e);
            }
        }

        // Start competition timer
        function startCompetitionTimer() {
            competitionTimerInterval = setInterval(() => {
                competitionElapsedTime = Date.now() - competitionStartTime;
                updateCompetitionTimeDisplay();
            }, 10);
        }

        // Theme toggle functionality
        themeToggle.addEventListener('click', () => {
            const currentTheme = document.body.getAttribute('data-theme') || 'dark';
            if (currentTheme === 'dark') {
                document.body.setAttribute('data-theme', 'light');
                themeSwitchHandle.style.right = '1px';
                themeSwitchHandle.style.left = 'auto';
                document.querySelector('.theme-toggle span').textContent = 'Светлая тема';
                localStorage.setItem('theme', 'light');
            } else {
                document.body.removeAttribute('data-theme');
                themeSwitchHandle.style.left = '1px';
                themeSwitchHandle.style.right = 'auto';
                document.querySelector('.theme-toggle span').textContent = 'Темная тема';
                localStorage.setItem('theme', 'dark');
            }
        });

        // Menu toggle functionality
        menuBtn.addEventListener('click', () => {
            dropdownMenu.classList.toggle('show');
        });

        // Close dropdown when clicking outside
        document.addEventListener('click', (e) => {
            if (!menuBtn.contains(e.target) && !dropdownMenu.contains(e.target)) {
                dropdownMenu.classList.remove('show');
            }
        });

        // Competition timer functionality
        competitionBtn.addEventListener('click', () => {
            if (!isCompetitionRunning) {
                startCompetition();
            } else {
                showConfirmationDialog();
            }
        });

        function startCompetition() {
            isCompetitionRunning = true;
            competitionStartTime = Date.now() - competitionElapsedTime;
            competitionBtn.innerHTML = '<span class="btn-icon">■</span><span>Завершить соревнование</span>';
            
            startCompetitionTimer();
            competitionTimeDisplay.classList.remove('hidden');
            
            // Enable all start buttons
            document.querySelectorAll('.start-btn.disabled').forEach(btn => {
                btn.classList.remove('disabled');
                btn.disabled = false;
            });
            
            saveData();
        }

        function showConfirmationDialog() {
            // Pause the timer while dialog is shown
            if (competitionTimerInterval) {
                clearInterval(competitionTimerInterval);
                competitionTimerInterval = null;
            }
            competitionPausedTime = Date.now();
            confirmationDialog.classList.add('show');
        }

        function hideConfirmationDialog() {
            confirmationDialog.classList.remove('show');
            
            // Resume timer if user cancels
            if (isCompetitionRunning) {
                const pauseDuration = Date.now() - competitionPausedTime;
                competitionStartTime += pauseDuration;
                startCompetitionTimer();
            }
        }

        confirmBtn.addEventListener('click', () => {
            endCompetition();
            hideConfirmationDialog();
        });

        cancelBtn.addEventListener('click', () => {
            hideConfirmationDialog();
        });

        function endCompetition() {
            isCompetitionRunning = false;
            if (competitionTimerInterval) {
                clearInterval(competitionTimerInterval);
                competitionTimerInterval = null;
            }
            competitionBtn.innerHTML = '<span class="btn-icon">▶</span><span>Начать соревнование</span>';
            
            // Mark all running participants as finished
            participants.forEach(participant => {
                if (participant.isRunning) {
                    stopParticipantTimer(participant.id, true);
                }
            });
            
            // Disable all start buttons
            document.querySelectorAll('.start-btn').forEach(btn => {
                btn.classList.add('disabled');
                btn.disabled = true;
            });
            
            saveData();
            showSuccessMessage('Соревнование завершено. Результаты сохранены.');
        }

        function updateCompetitionTimeDisplay() {
            competitionTimeDisplay.textContent = formatTime(competitionElapsedTime);
        }

        function formatTime(milliseconds) {
            if (isNaN(milliseconds)) return "00:00:00.00";
            
            const totalSeconds = Math.floor(milliseconds / 1000);
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            const seconds = totalSeconds % 60;
            const centiseconds = Math.floor((milliseconds % 1000) / 10);
            
            return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}.${centiseconds.toString().padStart(2, '0')}`;
        }

        // Participant functionality
        addParticipantBtn.addEventListener('click', () => {
            addParticipant();
            saveData();
        });

        function addParticipant() {
            const participant = {
                id: nextParticipantId++,
                number: participants.length + 1,
                comment: '',
                startTime: null,
                endTime: null,
                elapsedTime: 0,
                isRunning: false,
                timerInterval: null
            };
            
            participants.push(participant);
            renderParticipants();
        }

        function renderParticipants() {
            // Clear containers
            participantsContainer.innerHTML = '';
            groupsContainer.innerHTML = '';
            
            if (participants.length <= 10) {
                // Render all participants directly
                participants.forEach(participant => {
                    participantsContainer.appendChild(createParticipantCard(participant));
                });
            } else if (participants.length <= 100) {
                // Group by tens
                const groups = Math.ceil(participants.length / 10);
                
                for (let i = 0; i < groups; i++) {
                    const start = i * 10 + 1;
                    const end = Math.min((i + 1) * 10, participants.length);
                    
                    const groupDiv = document.createElement('div');
                    groupDiv.className = 'group-container';
                    
                    const toggleBtn = document.createElement('div');
                    toggleBtn.className = 'group-toggle';
                    toggleBtn.innerHTML = `<span>${start}-${end}</span><span>▼</span>`;
                    toggleBtn.addEventListener('click', () => {
                        const content = toggleBtn.nextElementSibling;
                        content.classList.toggle('show');
                        toggleBtn.querySelector('span:last-child').textContent = 
                            content.classList.contains('show') ? '▲' : '▼';
                    });
                    
                    const contentDiv = document.createElement('div');
                    contentDiv.className = 'group-content';
                    
                    for (let j = start - 1; j < end; j++) {
                        contentDiv.appendChild(createParticipantCard(participants[j]));
                    }
                    
                    groupDiv.appendChild(toggleBtn);
                    groupDiv.appendChild(contentDiv);
                    groupsContainer.appendChild(groupDiv);
                }
            } else {
                // Group by hundreds
                const hundredGroups = Math.ceil(participants.length / 100);
                
                for (let i = 0; i < hundredGroups; i++) {
                    const startHundred = i * 100 + 1;
                    const endHundred = Math.min((i + 1) * 100, participants.length);
                    
                    const hundredGroupDiv = document.createElement('div');
                    hundredGroupDiv.className = 'group-container';
                    
                    const hundredToggleBtn = document.createElement('div');
                    hundredToggleBtn.className = 'group-toggle';
                    hundredToggleBtn.innerHTML = `<span>${startHundred}-${endHundred}</span><span>▼</span>`;
                    hundredToggleBtn.addEventListener('click', () => {
                        const content = hundredToggleBtn.nextElementSibling;
                        content.classList.toggle('show');
                        hundredToggleBtn.querySelector('span:last-child').textContent = 
                            content.classList.contains('show') ? '▲' : '▼';
                    });
                    
                    const hundredContentDiv = document.createElement('div');
                    hundredContentDiv.className = 'group-content';
                    
                    // Create tens groups within hundreds
                    const tensInHundred = Math.ceil((endHundred - startHundred + 1) / 10);
                    
                    for (let j = 0; j < tensInHundred; j++) {
                        const startTen = startHundred + j * 10;
                        const endTen = Math.min(startHundred + (j + 1) * 10 - 1, endHundred);
                        
                        const tenGroupDiv = document.createElement('div');
                        tenGroupDiv.className = 'group-container';
                        
                        const tenToggleBtn = document.createElement('div');
                        tenToggleBtn.className = 'group-toggle';
                        tenToggleBtn.innerHTML = `<span>${startTen}-${endTen}</span><span>▶</span>`;
                        tenToggleBtn.addEventListener('click', () => {
                            const content = tenToggleBtn.nextElementSibling;
                            content.classList.toggle('show');
                            tenToggleBtn.querySelector('span:last-child').textContent = 
                                content.classList.contains('show') ? '▼' : '▶';
                        });
                        
                        const tenContentDiv = document.createElement('div');
                        tenContentDiv.className = 'group-content';
                        
                        for (let k = startTen - 1; k < Math.min(endTen, participants.length); k++) {
                            tenContentDiv.appendChild(createParticipantCard(participants[k]));
                        }
                        
                        tenGroupDiv.appendChild(tenToggleBtn);
                        tenGroupDiv.appendChild(tenContentDiv);
                        hundredContentDiv.appendChild(tenGroupDiv);
                    }
                    
                    hundredGroupDiv.appendChild(hundredToggleBtn);
                    hundredGroupDiv.appendChild(hundredContentDiv);
                    groupsContainer.appendChild(hundredGroupDiv);
                }
            }
        }

        function createParticipantCard(participant) {
            const card = document.createElement('div');
            card.className = 'participant-card';
            card.dataset.id = participant.id;
            
            const header = document.createElement('div');
            header.className = 'participant-header';
            
            const numberInput = document.createElement('div');
            numberInput.className = 'participant-number';
            numberInput.textContent = participant.number;
            numberInput.contentEditable = true;
            numberInput.addEventListener('blur', (e) => {
                const newValue = parseInt(e.target.textContent) || 1;
                if (!isNaN(newValue)) {
                    participant.number = newValue;
                    e.target.textContent = newValue;
                    saveData();
                }
            });
            
            const commentInput = document.createElement('input');
            commentInput.type = 'text';
            commentInput.className = 'participant-comment';
            commentInput.placeholder = 'Комментарий';
            commentInput.value = participant.comment;
            commentInput.addEventListener('input', (e) => {
                participant.comment = e.target.value;
                saveData();
            });
            
            header.appendChild(numberInput);
            header.appendChild(commentInput);
            card.appendChild(header);
            
            // Action buttons
            const actionButtons = document.createElement('div');
            actionButtons.className = 'action-buttons';
            
            const actionBtn = document.createElement('button');
            actionBtn.className = participant.isRunning ? 'stop-btn' : 'start-btn';
            
            // Disable start button if competition hasn't started
            if (!participant.isRunning && !isCompetitionRunning) {
                actionBtn.classList.add('disabled');
                actionBtn.disabled = true;
            }
            
            actionBtn.textContent = participant.isRunning ? 'Стоп' : 'Пуск';
            actionBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                if (!participant.isRunning) {
                    startParticipantTimer(participant.id);
                } else {
                    stopParticipantTimer(participant.id);
                }
            });
            
            actionButtons.appendChild(actionBtn);
            card.appendChild(actionButtons);
            
            // Delete text (not button) with margin
            const deleteText = document.createElement('div');
            deleteText.className = 'delete-text';
            deleteText.textContent = 'Удалить';
            deleteText.addEventListener('click', (e) => {
                e.stopPropagation();
                showDeleteConfirmationDialog(participant.id);
            });
            
            card.appendChild(deleteText);
            
            // Timer display (hidden initially)
            if (participant.startTime || participant.endTime) {
                const timerDisplay = document.createElement('div');
                timerDisplay.className = 'participant-timer';
                
                const startTimeDisplay = document.createElement('div');
                startTimeDisplay.textContent = participant.startTime ? 
                    new Date(participant.startTime).toLocaleTimeString() : '';
                
                const timerValue = document.createElement('div');
                timerValue.className = 'timer-value';
                timerValue.textContent = formatTime(participant.elapsedTime);
                
                const endTimeDisplay = document.createElement('div');
                endTimeDisplay.textContent = participant.endTime ? 
                    new Date(participant.endTime).toLocaleTimeString() : '';
                
                timerDisplay.appendChild(startTimeDisplay);
                timerDisplay.appendChild(timerValue);
                timerDisplay.appendChild(endTimeDisplay);
                
                card.appendChild(timerDisplay);
                
                // Update timer if still running
                if (participant.isRunning) {
                    startParticipantTimerInterval(participant);
                }
            }
            
            return card;
        }

        function startParticipantTimerInterval(participant) {
            // Clear any existing interval
            if (participant.timerInterval) {
                clearInterval(participant.timerInterval);
            }
            
            participant.timerInterval = setInterval(() => {
                participant.elapsedTime = Date.now() - participant.startTime;
                saveData();
                
                // Update UI
                const card = document.querySelector(`.participant-card[data-id="${participant.id}"]`);
                if (card) {
                    const timerValue = card.querySelector('.timer-value');
                    if (timerValue) {
                        timerValue.textContent = formatTime(participant.elapsedTime);
                    }
                }
            }, 10);
        }

        function startParticipantTimer(participantId) {
            // Check if competition is running
            if (!isCompetitionRunning) {
                showErrorMessage('Сначала начните соревнование!');
                return;
            }
            
            const participant = participants.find(p => p.id === participantId);
            if (!participant) return;
            
            participant.startTime = Date.now();
            participant.isRunning = true;
            
            // Update UI
            const card = document.querySelector(`.participant-card[data-id="${participantId}"]`);
            if (!card) return;
            
            const actionBtn = card.querySelector('.start-btn, .stop-btn');
            if (actionBtn) {
                actionBtn.className = 'stop-btn';
                actionBtn.textContent = 'Стоп';
                actionBtn.disabled = false;
            }
            
            // Add timer display if not exists
            let timerDisplay = card.querySelector('.participant-timer');
            if (!timerDisplay) {
                timerDisplay = document.createElement('div');
                timerDisplay.className = 'participant-timer';
                
                const startTimeDisplay = document.createElement('div');
                startTimeDisplay.textContent = new Date(participant.startTime).toLocaleTimeString();
                
                const timerValue = document.createElement('div');
                timerValue.className = 'timer-value';
                timerValue.textContent = formatTime(0);
                
                const endTimeDisplay = document.createElement('div');
                endTimeDisplay.textContent = '';
                
                timerDisplay.appendChild(startTimeDisplay);
                timerDisplay.appendChild(timerValue);
                timerDisplay.appendChild(endTimeDisplay);
                
                card.appendChild(timerDisplay);
            }
            
            // Start timer
            startParticipantTimerInterval(participant);
            
            saveData();
        }

        function stopParticipantTimer(participantId, forced = false) {
            const participant = participants.find(p => p.id === participantId);
            if (!participant) return;
            
            // Stop timer interval
            if (participant.timerInterval) {
                clearInterval(participant.timerInterval);
                participant.timerInterval = null;
            }
            
            participant.endTime = forced ? (competitionStartTime + competitionElapsedTime) : Date.now();
            participant.isRunning = false;
            participant.elapsedTime = participant.endTime - participant.startTime;
            
            // Update UI
            const card = document.querySelector(`.participant-card[data-id="${participantId}"]`);
            if (!card) return;
            
            const actionBtn = card.querySelector('.start-btn, .stop-btn');
            if (actionBtn) {
                actionBtn.className = 'start-btn';
                
                // Disable button if competition is not running
                if (!isCompetitionRunning) {
                    actionBtn.classList.add('disabled');
                    actionBtn.disabled = true;
                }
                
                actionBtn.textContent = 'Пуск';
            }
            
            // Update timer display
            const timerDisplay = card.querySelector('.participant-timer');
            if (timerDisplay) {
                const endTimeDisplay = timerDisplay.querySelector('div:last-child');
                if (endTimeDisplay) {
                    endTimeDisplay.textContent = new Date(participant.endTime).toLocaleTimeString();
                }
                
                const timerValue = timerDisplay.querySelector('.timer-value');
                if (timerValue) {
                    timerValue.textContent = formatTime(participant.elapsedTime);
                }
            }
            
            saveData();
        }

        // Delete participant functionality
        function showDeleteConfirmationDialog(participantId) {
            participantToDelete = participantId;
            deleteConfirmationDialog.classList.add('show');
        }

        deleteConfirmBtn.addEventListener('click', () => {
            if (participantToDelete !== null) {
                deleteParticipant(participantToDelete);
                participantToDelete = null;
            }
            deleteConfirmationDialog.classList.remove('show');
        });

        deleteCancelBtn.addEventListener('click', () => {
            participantToDelete = null;
            deleteConfirmationDialog.classList.remove('show');
        });

        function deleteParticipant(participantId) {
            // Find participant
            const participantIndex = participants.findIndex(p => p.id === participantId);
            if (participantIndex === -1) return;
            
            // Stop timer if running
            const participant = participants[participantIndex];
            if (participant && participant.isRunning && participant.timerInterval) {
                clearInterval(participant.timerInterval);
            }
            
            // Remove participant
            participants.splice(participantIndex, 1);
            
            // Renumber participants
            participants.forEach((p, index) => {
                p.number = index + 1;
            });
            
            renderParticipants();
            saveData();
            showSuccessMessage('Участник удален');
        }

        // Clear history functionality
        clearHistoryBtn.addEventListener('click', () => {
            clearHistoryDialog.classList.add('show');
            dropdownMenu.classList.remove('show');
        });

        clearConfirmBtn.addEventListener('click', () => {
            clearAllData();
            clearHistoryDialog.classList.remove('show');
        });

        clearCancelBtn.addEventListener('click', () => {
            clearHistoryDialog.classList.remove('show');
        });

        function clearAllData() {
            // Stop competition timer if running
            if (isCompetitionRunning && competitionTimerInterval) {
                clearInterval(competitionTimerInterval);
                competitionTimerInterval = null;
            }
            
            isCompetitionRunning = false;
            competitionStartTime = null;
            competitionElapsedTime = 0;
            participants = [];
            nextParticipantId = 1;
            
            // Update UI
            competitionBtn.innerHTML = '<span class="btn-icon">▶</span><span>Начать соревнование</span>';
            competitionTimeDisplay.classList.add('hidden');
            
            // Clear localStorage
            localStorage.removeItem('stopwatchData');
            
            // Re-render
            renderParticipants();
            
            showSuccessMessage('Вся история очищена');
        }

        // CSV Export/Import functionality
        exportBtn.addEventListener('click', () => {
            exportToCSV();
            dropdownMenu.classList.remove('show');
        });

        function exportToCSV() {
            try {
                // Create CSV content
                let csvContent = "Время начала соревнования,Время завершения соревнования,Время проведения соревнования\n";
                const startTime = competitionStartTime ? new Date(competitionStartTime).toLocaleString() : "";
                const endTime = competitionStartTime ? new Date(competitionStartTime + competitionElapsedTime).toLocaleString() : "";
                const duration = formatTime(competitionElapsedTime);
                csvContent += `${startTime},${endTime},${duration}\n\n`;
                
                // Participants header
                csvContent += "Номер участника,Время старта,Время завершения,Затраченное время,Комментарий\n";
                
                // Participants data
                participants.forEach(participant => {
                    const start = participant.startTime ? new Date(participant.startTime).toLocaleString() : "";
                    const end = participant.endTime ? new Date(participant.endTime).toLocaleString() : "";
                    const elapsed = formatTime(participant.elapsedTime);
                    // Escape quotes in comment
                    const comment = participant.comment.replace(/"/g, '""');
                    csvContent += `${participant.number},"${start}","${end}",${elapsed},"${comment}"\n`;
                });
                
                // Create Blob and download
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement("a");
                link.setAttribute("href", url);
                link.setAttribute("download", `competition_results_${new Date().toISOString().slice(0, 10)}.csv`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                
                showSuccessMessage('Таблица успешно экспортирована!');
            } catch (e) {
                console.error('Error exporting CSV:', e);
                showErrorMessage('Ошибка при экспорте таблицы');
            }
        }

        importBtn.addEventListener('click', () => {
            fileInput.click();
        });

        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(event) {
                try {
                    const csvData = event.target.result;
                    parseCSV(csvData);
                    dropdownMenu.classList.remove('show');
                } catch (e) {
                    console.error('Error importing CSV:', e);
                    showErrorMessage('Ошибка при импорте таблицы');
                }
            };
            reader.readAsText(file);
            
            // Reset file input
            fileInput.value = '';
        });

        function parseCSV(csvData) {
            const lines = csvData.split('\n');
            let participantsData = [];
            let inParticipantsSection = false;
            
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;
                
                // Skip competition info lines
                if (line.includes('Время начала соревнования')) {
                    continue;
                }
                
                // Check for participants header
                if (line.includes('Номер участника')) {
                    inParticipantsSection = true;
                    continue;
                }
                
                if (inParticipantsSection && line) {
                    const values = parseCSVLine(line);
                    if (values.length >= 5) {
                        let startTime = null;
                        let endTime = null;
                        
                        try {
                            if (values[1] && values[1] !== '""' && values[1] !== '"') {
                                const date1 = new Date(values[1]);
                                if (!isNaN(date1.getTime())) {
                                    startTime = date1.getTime();
                                }
                            }
                            
                            if (values[2] && values[2] !== '""' && values[2] !== '"') {
                                const date2 = new Date(values[2]);
                                if (!isNaN(date2.getTime())) {
                                    endTime = date2.getTime();
                                }
                            }
                        } catch (e) {
                            console.error('Error parsing dates:', e);
                        }
                        
                        participantsData.push({
                            number: parseInt(values[0]) || participants.length + 1,
                            startTime: startTime,
                            endTime: endTime,
                            elapsedTime: parseTimeToMilliseconds(values[3]),
                            comment: values[4].replace(/"/g, '')
                        });
                    }
                }
            }
            
            // Add imported participants
            participantsData.forEach(data => {
                const participant = {
                    id: nextParticipantId++,
                    number: data.number,
                    comment: data.comment,
                    startTime: data.startTime,
                    endTime: data.endTime,
                    elapsedTime: data.elapsedTime,
                    isRunning: false,
                    timerInterval: null
                };
                
                if (data.startTime && !data.endTime) {
                    participant.isRunning = true;
                }
                
                participants.push(participant);
            });
            
            renderParticipants();
            saveData();
            showSuccessMessage('Данные успешно импортированы!');
        }

        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                const nextChar = line[i + 1];
                
                if (char === '"' && !inQuotes) {
                    inQuotes = true;
                } else if (char === '"' && inQuotes && nextChar === '"') {
                    current += '"';
                    i++; // Skip the next quote
                } else if (char === '"' && inQuotes) {
                    inQuotes = false;
                } else if (char === ',' && !inQuotes) {
                    result.push(current);
                    current = '';
                } else {
                    current += char;
                }
            }
            
            result.push(current);
            return result;
        }

        function parseTimeToMilliseconds(timeStr) {
            if (!timeStr) return 0;
            
            try {
                const parts = timeStr.split(':');
                if (parts.length !== 3) return 0;
                
                const hours = parseInt(parts[0]) || 0;
                const minutes = parseInt(parts[1]) || 0;
                const secondsParts = parts[2].split('.');
                const seconds = parseInt(secondsParts[0]) || 0;
                const centiseconds = parseInt(secondsParts[1]) || 0;
                
                return (hours * 3600 + minutes * 60 + seconds) * 1000 + centiseconds * 10;
            } catch (e) {
                console.error('Error parsing time:', e);
                return 0;
            }
        }

        function showSuccessMessage(message) {
            successMessage.textContent = message;
            successMessage.style.display = 'block';
            
            setTimeout(() => {
                successMessage.style.display = 'none';
            }, 3000);
        }

        function showErrorMessage(message) {
            errorMessage.textContent = message;
            errorMessage.style.display = 'block';
            
            setTimeout(() => {
                errorMessage.style.display = 'none';
            }, 3000);
        }

        // Initialize the app
        document.addEventListener('DOMContentLoaded', loadData);
    </script>
</body>
</html>
